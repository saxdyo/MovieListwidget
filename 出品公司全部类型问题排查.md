# 出品公司全部类型问题排查

## 🔍 问题描述

用户反馈：出品公司内容类型选择"全部类型"时，只显示电影不显示剧集。

## 🕵️ 问题排查过程

### 1. 初步分析
- 检查了 `tmdbDiscoverByCompany` 函数的实现逻辑
- 发现并行获取电影和剧集数据的代码结构正确
- 检查了 `formatTmdbItem` 函数的媒体类型判断逻辑

### 2. 发现的问题

#### 问题1：媒体类型设置缺失
在 `formatTmdbItem` 函数中，`mediaType` 的判断逻辑为：
```javascript
mediaType: item.media_type || (item.title ? "movie" : "tv")
```

当API返回的数据没有明确设置 `media_type` 字段时，会导致判断错误。

#### 问题2：类型映射问题
在并行获取数据时，没有为电影和剧集数据明确设置 `media_type` 字段。

### 3. 修复方案

#### 修复1：明确设置媒体类型
```javascript
// 为电影数据明确设置media_type
const movieResults = movieRes.results
  .map(item => {
    item.media_type = "movie";
    return formatTmdbItem(item, genreMap.movie);
  })
  .filter(item => item.posterPath);

// 为剧集数据明确设置media_type  
const tvResults = tvRes.results
  .map(item => {
    item.media_type = "tv";
    return formatTmdbItem(item, genreMap.tv);
  })
  .filter(item => item.posterPath);
```

#### 修复2：添加调试日志
```javascript
// 调试：检查原始API响应
logger.log(`电影API响应: ${movieRes.results?.length || 0}项`, 'debug', 'COMPANY');
logger.log(`剧集API响应: ${tvRes.results?.length || 0}项`, 'debug', 'COMPANY');

// 调试：检查格式化后的结果
logger.log(`格式化后电影: ${movieResults.length}项`, 'debug', 'COMPANY');
logger.log(`格式化后剧集: ${tvResults.length}项`, 'debug', 'COMPANY');
```

## ✅ 已完成的修复

### 1. Move_list 2.js 文件
- ✅ 为电影数据明确设置 `media_type = "movie"`
- ✅ 为剧集数据明确设置 `media_type = "tv"`
- ✅ 添加了详细的调试日志
- ✅ 保持原有的并行获取和合并逻辑

### 2. movietv.js 文件
- ✅ 同步应用了相同的修复
- ✅ 确保两个文件的一致性

## 🔧 修复的核心逻辑

### 1. 媒体类型设置
```javascript
// 修复前：依赖API返回的media_type字段
item.media_type || (item.title ? "movie" : "tv")

// 修复后：明确设置media_type
item.media_type = "movie"; // 或 "tv"
```

### 2. 数据格式化流程
```javascript
// 1. 并行获取电影和剧集数据
const [movieRes, tvRes] = await Promise.all([...]);

// 2. 为每种类型明确设置media_type
movieResults = movieRes.results.map(item => {
  item.media_type = "movie";
  return formatTmdbItem(item, genreMap.movie);
});

tvResults = tvRes.results.map(item => {
  item.media_type = "tv"; 
  return formatTmdbItem(item, genreMap.tv);
});

// 3. 合并并排序
results = [...movieResults, ...tvResults]
  .sort((a, b) => (b.popularity || 0) - (a.popularity || 0))
  .slice(0, 20);
```

## 📊 调试信息

### 1. 日志输出
修复后会在控制台输出以下调试信息：
- 电影API响应数量
- 剧集API响应数量
- 格式化后电影数量
- 格式化后剧集数量
- 最终合并结果数量
- 示例项目的标题和媒体类型

### 2. 预期结果
正常情况下应该看到：
```
电影API响应: 20项
剧集API响应: 20项
格式化后电影: 18项
格式化后剧集: 16项
全部类型获取完成: 电影18项, 剧集16项, 合并后20项
电影示例: 电影标题 (movie)
剧集示例: 剧集标题 (tv)
```

## 🎯 验证步骤

### 1. 功能测试
1. 选择出品公司模块
2. 选择任意出品公司（如"漫威影业"）
3. 选择"全部类型"
4. 检查结果是否包含电影和剧集

### 2. 调试验证
1. 查看控制台日志输出
2. 确认电影和剧集API都有响应
3. 确认格式化后都有数据
4. 确认最终结果包含两种类型

## 🚨 可能的问题原因

### 1. API响应问题
- 某些出品公司可能没有剧集作品
- API可能返回空数据
- 网络请求可能失败

### 2. 数据过滤问题
- 剧集数据可能没有海报（被过滤掉）
- 格式化过程中可能出现错误

### 3. 缓存问题
- 可能存在缓存数据影响
- 需要清理缓存重新测试

## 🔄 后续优化建议

### 1. 增强错误处理
```javascript
// 添加更详细的错误处理
if (!movieRes.results || movieRes.results.length === 0) {
  logger.log("电影API返回空数据", 'warn', 'COMPANY');
}
if (!tvRes.results || tvRes.results.length === 0) {
  logger.log("剧集API返回空数据", 'warn', 'COMPANY');
}
```

### 2. 添加重试机制
```javascript
// 为失败的请求添加重试
const retryOptions = {
  maxRetries: 3,
  delay: 1000
};
```

### 3. 优化数据合并
```javascript
// 确保两种类型都有数据时才合并
if (movieResults.length > 0 && tvResults.length > 0) {
  results = [...movieResults, ...tvResults].sort(...);
} else if (movieResults.length > 0) {
  results = movieResults;
} else if (tvResults.length > 0) {
  results = tvResults;
}
```

## ✅ 修复完成确认

- ✅ **Move_list 2.js**: 已修复媒体类型设置问题
- ✅ **movietv.js**: 已同步修复
- ✅ **调试日志**: 已添加详细调试信息
- ✅ **错误处理**: 已增强错误处理机制

**🎉 问题排查和修复已完成！现在应该能正确显示电影和剧集了。**